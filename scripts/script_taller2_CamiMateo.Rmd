---
title: "script_taller2"
output: null
date: "2025-03-19"
editor_options: 
  markdown: 
    wrap: 72
---

# 0. CONFIGURACIÓN INICIAL

## Librerias

```{r}

rm(list = ls())
require(pacman)

p_load(
  tidyverse,
  caret,
  glmnet,
  Metrics,
  MLmetrics,
  skimr,
  xgboost,
  biglm,
  data.table
  )
```

## Carga de datos y joints

```{r}
raw_data_path <- '../data'

# Datos training
hogares_tr <- read.csv(file.path(raw_data_path, 'train_hogares.csv'))
personas_tr <- read.csv(file.path(raw_data_path, 'train_personas.csv'))

# Datos test
hogares_te <- read.csv(file.path(raw_data_path, 'test_hogares.csv'))
personas_te <- read.csv(file.path(raw_data_path, 'test_personas.csv'))
```

Creación de partición con datos de training para facilitar el ejercicio
de predicción antes de cargar intentos a Kaggle

```{r}
set.seed(3003)

# Validation set con 20% datos de prueba y 80% datos de entrenamiento 
inTrain <- createDataPartition( # Método de caret para establecer validation set aleatoriamente elegido
  y = hogares_tr$Pobre,  # Variable explicada
  p = .80, # Porcentaje de datos para entrenamiento
  list = FALSE
)

hogares_train <- hogares_tr %>% 
  filter(row_number() %in% inTrain)

hogares_validation  <- hogares_tr %>% 
  filter(!row_number() %in% inTrain)
```

```{r}
# Tabla training
bd_train <- personas_tr %>%
  right_join(hogares_train, join_by("id", "Clase", "Dominio", "Fex_c", "Depto", "Fex_dpto"))

bd_validation <- personas_tr %>%
  right_join(hogares_validation, join_by("id", "Clase", "Dominio", "Fex_c", "Depto", "Fex_dpto"))

# Tabla test
bd_test <- personas_te %>%
  left_join(hogares_te, join_by("id", "Clase", "Dominio", "Fex_c", "Depto", "Fex_dpto"))
```

## Selección de variables (Train)

```{r}
bd_train <- bd_train %>%
  select(
    "id",
    "Clase",
    "Dominio", # Ciudad
    "Depto",
    "Nper", # Número de personas por hogar
    "P6020", # Sexo 1 hombre, 2 mujer
    "P6040", # Edad
    "P6090", # Cotizante en salud
    "P6100", # Tipo de regimen de SS en salud
    "P6210", # Nivel educativo
    "P6210s1", # Grado escolar aprobado
    "Oc", # Ocupado 1
    "Ina", # Inactivo 1
    "Lp", # Línea de pobreza
    "P6240", # Actividad de la semana anterior
    "Oficio", # Tipo de ocupación
    "P6426", # Tiempo laborando en la empresa
    "P6430", # Cargo desempeñado en el trabajo
    "P6510", # Dicótoma: ingresos por horas extra
    "P6545", # Dicótoma: ingresos por primas
    "P6580", # Dicótoma: ingresos por bonificaciones
    "P6585s1", # Dicótoma: ingresos por alimentación
    "P6585s2", # Dicótoma: ingresos por subsidio de transporte
    "P6585s3", # Dicótoma: ingresos por subsidio familiar
    "P6585s4", # Dicótoma: ingresos por subsidio educativo
    "P6590",  # Dicótoma: ingresos en especie con alimentación
    "P6600", # Dicótoma: ingresos en especie con vivienda
    "P6610", # Dicótoma: usa transporte de la empresa para desplazarse al trabajo   
    "P6620", # Dicótoma: otros ingresos en especie
    "P6630s1", # Dicótoma: ingresos por prima de servicios últimos 12 meses
    "P6630s2", # Dicótoma: ingresos por prima de navidad últimos 12 meses
    "P6630s3", # Dicótoma: ingresos por prima de vacaciones últimos 12 meses
    "P6630s4", # Dicótoma: ingresos por viáticos permanentes últimos 12 meses
    "P6630s6", # Dicótoma: ingresos por bonificaciones anuales últimos 12 meses
    "P6800", # Horas laboradas durante la última semana
    "P6870", # Categórica sobre cantidad de empleados en la empresa
    "P6920", # Cotiza a fondo de pensiones
    "P7040", # Dicótoma: desempeña una actividad secundaria
    "P7045", # Horas laboradas durante la última semana en actividad secundaria
    "P7050", # Tipo de ocupación en el segundo trabajo
    "P7090", # Dicótoma: tiene interés en trabajar más horas
    "P7110", # Dicótoma: ha intentado trabajar más horas en el último mes
    "P7120", # Dicótoma: tiene disponibilidad para trabajar más horas
    "P7150", # Dicótoma: ha buscado trabajo durante las últimas 4 semanas
    "P7160", # Dicótoma: puede comenzar un nuevo empleo dentro del mes siguiente
    "P7310", # Dicótoma: ha trabajado antes durante por lo menos 2 semanas
    "P7350", # Cargo que ocupaba en su anterior trabajo (desocupados)
    "P7472", # Ha tenido ingresos durante el mes anterior (desocupados) 
    "P7495", # Dicótoma: recibió ingresos por arriendos el mes pasado
    "P7500s2", # Dicótoma: recibió ingresos por pensión el mes pasado
    "P7500s3", # Dicótoma: recibió ingresos por pensión alimenticia el mes pasado
    "P7510s1", # Dicótoma: recibió ingresos de otros hogares nacionales el mes pasado
    "P7510s2", # Dicótoma: recibió ingresos de otros hogares extranjeros el mes pasado
    "P7510s3", # Dicótoma: recibió ingresos de instituciones el mes pasado
    "P7510s6", # Dicótoma: recibió ingresos de intereses o dividendos el mes pasado
    "P7510s7", # Dicótoma: recibió ingresos de otras fuentes el mes pasado
    "Ingtot", # Ingreso total # No está en test 
    
    # Características del hogar
    "P5000", # Cantidad de cuartos en el hogar
    "P5010", # Cantidad de cuartos usados como dormitorios
    "P5090", # La vivienda es propia, arrendada, usufructuada, etc.
    "P5100", # Valor de la cuota de amortización
    "P5130", # Estimación del valor de habitar la vivienda en caso de ser arrendada
    "P5140", # Valor del arriendo
    
     # Variables de resultado
    "Pobre", # Pobre 1, de lo contrario 0 (Variable dependiente en training)
    "Ingtotug", # Ingreso per capita de la unidad de gasto (hogar) (Variable dependiente en training)
    
    # Variables secundarias
    #"Estrato1", # No está en test
    #"Impa", # Ingreso primera actividad # No está en test
    #"Impaes", # Ingreso primera actividad imputado # No está en test
    #"Isa", # Ingreso segunda actividad # No está en test
    #"Isaes", # Ingreso segunda actividad # No está en test
    #"Ie", # Ingreso en especie # No está en test
    #"Iees", # Ingreso en especie imputado # No está en test
    #"Imdi", # Ingreso de desempleados e inactivos # No está en test
    #"Imdies", # Ingreso de desempleados e inactivos imputado # No está en test
    #"Iof1", # Ingreso por intereses y dividendos # No está en test
    #"Iof1es", # Ingreso por intereses y dividendos imputado # No está en test
    #"Iof2", # Ingreso por pensión # No está en test
    #"Iof2es", # Ingreso por pensión imputado # No está en test
    #"Iof3h", # Ingreso por ayudas de hogares # No está en test
    #"Iof3hes", # Ingreso por ayudas de hogares imputado # No está en test
    #"Iof3i", # Ingreso por instituciones # No está en test
    #"Iof3ies", # Ingreso por instituciones imputado # No está en test
    #"Iof6", # Ingreso por arriendos # No está en test
    #"Iof6es", # Ingreso por arriendos imputado # No está en test
    
    # En test aparecen las dicótomas sobre si recibe o no ingresos por los siguientes conceptos
    #"P6500", # Ingresos recibidos # No está en test
    #"P6510s1", # Ingresos por horas extras # No está en test
    #"P6510s2", # Reportó o no el ingreso por horas extras # No está en test
    #"P6545s1", # Ingresos por primas # No está en test
    #"P6545s2", # Reportó o no el ingreso por primas # No está en test
    #"P6580s1", # Ingresos por bonificaciones      # No está en test
    #"P6580s2", # Reportó o no el ingreso por bonificaciones # No está en test
    #"P6585s1a1", # Subsidio de alimentación # No está en test
    #"P6585s1a2", # Reportó o no el subsidio de alimentación # No está en test
    #"P6585s2a1", # Auxilio de transporte  # No está en test
    #"P6585s2a2", # Reportó o no el auxilio de transporte # No está en test
    #"P6585s3a1", # Subsidio familiar    # No está en test
    #"P6585s3a2", # Reportó o no el subsidio familiar # No está en test
    #"P6585s4a1", # Subsidio educativo    # No está en test
    #"P6585s4a2", # Reportó o no el subsidio educativo # No está en test
    #"P6590s1", # Pago en especie con alimentos # No está en test
    #"P6600s1", # Pago en especie con vivienda # No está en test
    #"P6610s1", # Valor estimado de transporte prestado por la empresa # No está en test
    #"P6620s1", # Valor de pagos en especie con otros elementos # No está en test
    #"P6630s1a1", # Valor prima de servicios ultimos 12 meses # No está en test
    #"P6630s2a1", # Valor prima de navidad últimos 12 meses # No está en test
    #"P6630s3a1", # Valor prima de vacaciones últimos 12 meses # No está en test
    #"P6630s4a1", # Valor de los viaticos permanentes últimos 12 meses # No está en test
    #"P6630s6a1", # Valor de las bonificaciones anuales # No está en test
    #"P6750", # Ganancia neta del negocio # No está en test
    #"P6760", # Cantidad de meses a los que corresponde ese ingreso # No está en test
    #"P6870", # Cantidad de personas en la empresa # No está en test
    #"P6920", # Cotiza a fondo de pensiones # No está en test
    #"P7070", # Ingresos por segundo trabajo # No está en test
    #"P7500s1a1", # Ingresos recibidos por arriendos # No está en test
    #"P7500s2a1", # Ingresos por pensiones # No está en test
    #"P7500s3a1", # Ingresos por pensión alimentaria # No está en test
    #"P7510s1a1", # Ingresos provenientes de otros hogares en los últimos 12 meses # No está en test
    #"P7510s2a1", # Remesas en los últimos 12 meses # No está en test
    #"P7510s3a1", # Ayudas de instituciones en los últimos 12 meses # No está en test
    #"P7510s5a1", # Ingresos financieros en los últimos 12 meses # No está en test
    #"P7510s6a1", # Ingresos cesantías en los últimos 12 meses # No está en test
    #"P7510s7a1", # Otros ingresos anuales # No está en test
  )
```

```{r}
bd_validation <- bd_validation %>%
  select(
    "id",
    "Clase",
    "Dominio", # Ciudad
    "Depto",
    "Nper", # Número de personas por hogar
    "P6020", # Sexo 1 hombre, 2 mujer
    "P6040", # Edad
    "P6090", # Cotizante en salud
    "P6100", # Tipo de regimen de SS en salud
    "P6210", # Nivel educativo
    "P6210s1", # Grado escolar aprobado
    "Oc", # Ocupado 1
    "Ina", # Inactivo 1
    "Lp", # Línea de pobreza
    "P6240", # Actividad de la semana anterior
    "Oficio", # Tipo de ocupación
    "P6426", # Tiempo laborando en la empresa
    "P6430", # Cargo desempeñado en el trabajo
    "P6510", # Dicótoma: ingresos por horas extra
    "P6545", # Dicótoma: ingresos por primas
    "P6580", # Dicótoma: ingresos por bonificaciones
    "P6585s1", # Dicótoma: ingresos por alimentación
    "P6585s2", # Dicótoma: ingresos por subsidio de transporte
    "P6585s3", # Dicótoma: ingresos por subsidio familiar
    "P6585s4", # Dicótoma: ingresos por subsidio educativo
    "P6590",  # Dicótoma: ingresos en especie con alimentación
    "P6600", # Dicótoma: ingresos en especie con vivienda
    "P6610", # Dicótoma: usa transporte de la empresa para desplazarse al trabajo   
    "P6620", # Dicótoma: otros ingresos en especie
    "P6630s1", # Dicótoma: ingresos por prima de servicios últimos 12 meses
    "P6630s2", # Dicótoma: ingresos por prima de navidad últimos 12 meses
    "P6630s3", # Dicótoma: ingresos por prima de vacaciones últimos 12 meses
    "P6630s4", # Dicótoma: ingresos por viáticos permanentes últimos 12 meses
    "P6630s6", # Dicótoma: ingresos por bonificaciones anuales últimos 12 meses
    "P6800", # Horas laboradas durante la última semana
    "P6870", # Categórica sobre cantidad de empleados en la empresa
    "P6920", # Cotiza a fondo de pensiones
    "P7040", # Dicótoma: desempeña una actividad secundaria
    "P7045", # Horas laboradas durante la última semana en actividad secundaria
    "P7050", # Tipo de ocupación en el segundo trabajo
    "P7090", # Dicótoma: tiene interés en trabajar más horas
    "P7110", # Dicótoma: ha intentado trabajar más horas en el último mes
    "P7120", # Dicótoma: tiene disponibilidad para trabajar más horas
    "P7150", # Dicótoma: ha buscado trabajo durante las últimas 4 semanas
    "P7160", # Dicótoma: puede comenzar un nuevo empleo dentro del mes siguiente
    "P7310", # Dicótoma: ha trabajado antes durante por lo menos 2 semanas
    "P7350", # Cargo que ocupaba en su anterior trabajo (desocupados)
    "P7472", # Ha tenido ingresos durante el mes anterior (desocupados) 
    "P7495", # Dicótoma: recibió ingresos por arriendos el mes pasado
    "P7500s2", # Dicótoma: recibió ingresos por pensión el mes pasado
    "P7500s3", # Dicótoma: recibió ingresos por pensión alimenticia el mes pasado
    "P7510s1", # Dicótoma: recibió ingresos de otros hogares nacionales el mes pasado
    "P7510s2", # Dicótoma: recibió ingresos de otros hogares extranjeros el mes pasado
    "P7510s3", # Dicótoma: recibió ingresos de instituciones el mes pasado
    "P7510s6", # Dicótoma: recibió ingresos de intereses o dividendos el mes pasado
    "P7510s7", # Dicótoma: recibió ingresos de otras fuentes el mes pasado
    "Ingtot", # Ingreso total # No está en test 
    
    # Características del hogar
    "P5000", # Cantidad de cuartos en el hogar
    "P5010", # Cantidad de cuartos usados como dormitorios
    "P5090", # La vivienda es propia, arrendada, usufructuada, etc.
    "P5100", # Valor de la cuota de amortización
    "P5130", # Estimación del valor de habitar la vivienda en caso de ser arrendada
    "P5140", # Valor del arriendo
    
     # Variables de resultado
    "Pobre", # Pobre 1, de lo contrario 0 (Variable dependiente en training)
    "Ingtotug", # Ingreso per capita de la unidad de gasto (hogar) (Variable dependiente en training)
    
    # Variables secundarias
    #"Estrato1", # No está en test
    #"Impa", # Ingreso primera actividad # No está en test
    #"Impaes", # Ingreso primera actividad imputado # No está en test
    #"Isa", # Ingreso segunda actividad # No está en test
    #"Isaes", # Ingreso segunda actividad # No está en test
    #"Ie", # Ingreso en especie # No está en test
    #"Iees", # Ingreso en especie imputado # No está en test
    #"Imdi", # Ingreso de desempleados e inactivos # No está en test
    #"Imdies", # Ingreso de desempleados e inactivos imputado # No está en test
    #"Iof1", # Ingreso por intereses y dividendos # No está en test
    #"Iof1es", # Ingreso por intereses y dividendos imputado # No está en test
    #"Iof2", # Ingreso por pensión # No está en test
    #"Iof2es", # Ingreso por pensión imputado # No está en test
    #"Iof3h", # Ingreso por ayudas de hogares # No está en test
    #"Iof3hes", # Ingreso por ayudas de hogares imputado # No está en test
    #"Iof3i", # Ingreso por instituciones # No está en test
    #"Iof3ies", # Ingreso por instituciones imputado # No está en test
    #"Iof6", # Ingreso por arriendos # No está en test
    #"Iof6es", # Ingreso por arriendos imputado # No está en test
    
    # En test aparecen las dicótomas sobre si recibe o no ingresos por los siguientes conceptos
    #"P6500", # Ingresos recibidos # No está en test
    #"P6510s1", # Ingresos por horas extras # No está en test
    #"P6510s2", # Reportó o no el ingreso por horas extras # No está en test
    #"P6545s1", # Ingresos por primas # No está en test
    #"P6545s2", # Reportó o no el ingreso por primas # No está en test
    #"P6580s1", # Ingresos por bonificaciones      # No está en test
    #"P6580s2", # Reportó o no el ingreso por bonificaciones # No está en test
    #"P6585s1a1", # Subsidio de alimentación # No está en test
    #"P6585s1a2", # Reportó o no el subsidio de alimentación # No está en test
    #"P6585s2a1", # Auxilio de transporte  # No está en test
    #"P6585s2a2", # Reportó o no el auxilio de transporte # No está en test
    #"P6585s3a1", # Subsidio familiar    # No está en test
    #"P6585s3a2", # Reportó o no el subsidio familiar # No está en test
    #"P6585s4a1", # Subsidio educativo    # No está en test
    #"P6585s4a2", # Reportó o no el subsidio educativo # No está en test
    #"P6590s1", # Pago en especie con alimentos # No está en test
    #"P6600s1", # Pago en especie con vivienda # No está en test
    #"P6610s1", # Valor estimado de transporte prestado por la empresa # No está en test
    #"P6620s1", # Valor de pagos en especie con otros elementos # No está en test
    #"P6630s1a1", # Valor prima de servicios ultimos 12 meses # No está en test
    #"P6630s2a1", # Valor prima de navidad últimos 12 meses # No está en test
    #"P6630s3a1", # Valor prima de vacaciones últimos 12 meses # No está en test
    #"P6630s4a1", # Valor de los viaticos permanentes últimos 12 meses # No está en test
    #"P6630s6a1", # Valor de las bonificaciones anuales # No está en test
    #"P6750", # Ganancia neta del negocio # No está en test
    #"P6760", # Cantidad de meses a los que corresponde ese ingreso # No está en test
    #"P6870", # Cantidad de personas en la empresa # No está en test
    #"P6920", # Cotiza a fondo de pensiones # No está en test
    #"P7070", # Ingresos por segundo trabajo # No está en test
    #"P7500s1a1", # Ingresos recibidos por arriendos # No está en test
    #"P7500s2a1", # Ingresos por pensiones # No está en test
    #"P7500s3a1", # Ingresos por pensión alimentaria # No está en test
    #"P7510s1a1", # Ingresos provenientes de otros hogares en los últimos 12 meses # No está en test
    #"P7510s2a1", # Remesas en los últimos 12 meses # No está en test
    #"P7510s3a1", # Ayudas de instituciones en los últimos 12 meses # No está en test
    #"P7510s5a1", # Ingresos financieros en los últimos 12 meses # No está en test
    #"P7510s6a1", # Ingresos cesantías en los últimos 12 meses # No está en test
    #"P7510s7a1", # Otros ingresos anuales # No está en test
  )
```

## Selección de variables (Test)

```{r}
bd_test <- bd_test %>%
  select(
    "id",
    "Clase",
    "Dominio", # Ciudad
    "Depto",
    "Nper", # Número de personas por hogar
    "P6020", # Sexo 1 hombre, 2 mujer
    "P6040", # Edad
    "P6090", # Cotizante en salud
    "P6100", # Tipo de regimen de SS en salud
    "P6210", # Nivel educativo
    "P6210s1", # Grado escolar aprobado
    "Oc", # Ocupado 1
    "Ina", # Inactivo 1
    "Lp", # Línea de pobreza
    "P6240", # Actividad de la semana anterior
    "Oficio", # Tipo de ocupación
    "P6426", # Tiempo laborando en la empresa
    "P6430", # Cargo desempeñado en el trabajo
    "P6510", # Dicótoma: ingresos por horas extra
    "P6545", # Dicótoma: ingresos por primas
    "P6580", # Dicótoma: ingresos por bonificaciones
    "P6585s1", # Dicótoma: ingresos por alimentación
    "P6585s2", # Dicótoma: ingresos por subsidio de transporte
    "P6585s3", # Dicótoma: ingresos por subsidio familiar
    "P6585s4", # Dicótoma: ingresos por subsidio educativo
    "P6590",  # Dicótoma: ingresos en especie con alimentación
    "P6600", # Dicótoma: ingresos en especie con vivienda
    "P6610", # Dicótoma: usa transporte de la empresa para desplazarse al trabajo   
    "P6620", # Dicótoma: otros ingresos en especie
    "P6630s1", # Dicótoma: ingresos por prima de servicios últimos 12 meses
    "P6630s2", # Dicótoma: ingresos por prima de navidad últimos 12 meses
    "P6630s3", # Dicótoma: ingresos por prima de vacaciones últimos 12 meses
    "P6630s4", # Dicótoma: ingresos por viáticos permanentes últimos 12 meses
    "P6630s6", # Dicótoma: ingresos por bonificaciones anuales últimos 12 meses
    "P6800", # Horas laboradas durante la última semana
    "P6870", # Categórica sobre cantidad de empleados en la empresa
    "P6920", # Cotiza a fondo de pensiones
    "P7040", # Dicótoma: desempeña una actividad secundaria
    "P7045", # Horas laboradas durante la última semana en actividad secundaria
    "P7050", # Tipo de ocupación en el segundo trabajo
    "P7090", # Dicótoma: tiene interés en trabajar más horas
    "P7110", # Dicótoma: ha intentado trabajar más horas en el último mes
    "P7120", # Dicótoma: tiene disponibilidad para trabajar más horas
    "P7150", # Dicótoma: ha buscado trabajo durante las últimas 4 semanas
    "P7160", # Dicótoma: puede comenzar un nuevo empleo dentro del mes siguiente
    "P7310", # Dicótoma: ha trabajado antes durante por lo menos 2 semanas
    "P7350", # Cargo que ocupaba en su anterior trabajo (desocupados)
    "P7472", # Ha tenido ingresos durante el mes anterior (desocupados) 
    "P7495", # Dicótoma: recibió ingresos por arriendos el mes pasado
    "P7500s2", # Dicótoma: recibió ingresos por pensión el mes pasado
    "P7500s3", # Dicótoma: recibió ingresos por pensión alimenticia el mes pasado
    "P7510s1", # Dicótoma: recibió ingresos de otros hogares nacionales el mes pasado
    "P7510s2", # Dicótoma: recibió ingresos de otros hogares extranjeros el mes pasado
    "P7510s3", # Dicótoma: recibió ingresos de instituciones el mes pasado
    "P7510s6", # Dicótoma: recibió ingresos de intereses o dividendos el mes pasado
    "P7510s7", # Dicótoma: recibió ingresos de otras fuentes el mes pasado
    
    # Características del hogar
    "P5000", # Cantidad de cuartos en el hogar
    "P5010", # Cantidad de cuartos usados como dormitorios
    "P5090", # La vivienda es propia, arrendada, usufructuada, etc.
    "P5100", # Valor de la cuota de amortización
    "P5130", # Estimación del valor de habitar la vivienda en caso de ser arrendada
    "P5140", # Valor del arriendo
  )
```

## Limpieza de la BD para training

```{r}
rename_dict <- c(
  "Nper" = "nper",
  "P6020" = "female", 
  "P6040" = "age",
  "P6090" = "coti_salud",
  "P6100" = "reg_salud",
  "P6210" = "educ",
  "P6210s1" = "grado_escolar",
  "Oficio" = "oficio",
  "P6430" = "cargo",
  "Oc" = "ocupado",
  "Ina" = "inactivo",
  "P6240" = "ocu_sem_pas", # Actividad de la semana anterior
  "P6426" = "tenure", # Tiempo laborando en la empresa
  "P6510" = "horas_extra", # Dicótoma: ingresos por horas extra
  "P6545" = "primas", # Dicótoma: ingresos por primas
  "P6580" = "bonificaciones", # Dicótoma: ingresos por bonificaciones
  "P6585s1" = "alimentacion", # Dicótoma: ingresos por alimentación
  "P6585s2" = "aux_transporte", # Dicótoma: ingresos por subsidio de transporte
  "P6585s3" = "sub_familiar", # Dicótoma: ingresos por subsidio familiar
  "P6585s4" = "sub_educ", # Dicótoma: ingresos por subsidio educativo
  "P6590" = "ie_alimentacion",  # Dicótoma: ingresos en especie con alimentación
  "P6600" = "ie_vivienda", # Dicótoma: ingresos en especie con vivienda
  "P6610" = "trans_empresa", # Dicótoma: usa transporte de la empresa para desplazarse al trabajo   
  "P6620" = "ie_otros", # Dicótoma: otros ingresos en especie
  "P6630s1" = "prima_servicios", # Dicótoma: ingresos por prima de servicios últimos 12 meses
  "P6630s2" = "prima_navidad", # Dicótoma: ingresos por prima de navidad últimos 12 meses
  "P6630s3" = "prima_vacaciones", # Dicótoma: ingresos por prima de vacaciones últimos 12 meses
  "P6630s4" = "viaticos", # Dicótoma: ingresos por viáticos permanentes últimos 12 meses
  "P6630s6" = "bono_anual", # Dicótoma: ingresos por bonificaciones anuales últimos 12 meses
  "P6800" = "hr_lab", # Horas laboradas durante la última semana
  "P6870" = "empleados_empresa", # Categórica sobre cantidad de empleados en la empresa
  "P6920" = "cotiz_pension", # Cotiza a fondo de pensiones
  "P7040" = "segundo_trabajo", # Dicótoma: desempeña una actividad secundaria
  "P7045" = "hr_lab2", # Horas laboradas durante la última semana en actividad secundaria
  "P7050" = "cargo2", # Tipo de ocupación en el segundo trabajo
  "P7090" = "interes_mas_hr", # Dicótoma: tiene interés en trabajar más horas
  "P7110" = "intent_mas_hr", # Dicótoma: ha intentado trabajar más horas en el último mes
  "P7120" = "dispon_mas_hr", # Dicótoma: tiene disponibilidad para trabajar más horas
  "P7150" = "busca_trabajo", # Dicótoma: ha buscado trabajo durante las últimas 4 semanas
  "P7160" = "dispon_nuevo_trab", # Dicótoma: puede comenzar un nuevo empleo dentro del mes siguiente
  "P7310" = "primer_trabajo", # Dicótoma: ha trabajado antes durante por lo menos 2 semanas
  "P7350" = "cargo_anterior", # Cargo que ocupaba en su anterior trabajo (desocupados)
  "P7472" = "ingreso_anterior", # Dicótoma: si ha tenido ingresos durante el mes anterior (desocupados) 
  "P7495" = "ing_arriendo", # Dicótoma: recibió ingresos por arriendos el mes pasado
  "P7500s2" = "ing_pension", # Dicótoma: recibió ingresos por pensión el mes pasado
  "P7500s3" = "ing_alimentos", # Dicótoma: recibió ingresos por pensión alimenticia el mes pasado
  "P7510s1" = "remesa_nal", # Dicótoma: recibió ingresos de otros hogares nacionales el mes pasado
  "P7510s2" = "remesa_ext", # Dicótoma: recibió ingresos de otros hogares extranjeros el mes pasado
  "P7510s3" = "ayudas", # Dicótoma: recibió ingresos de instituciones el mes pasado
  "P7510s6" = "ing_int", # Dicótoma: recibió ingresos de intereses o dividendos el mes pasado
  "P7510s7" = "ing_otros", # Dicótoma: recibió ingresos de otras fuentes el mes pasado
   
  # Características del hogar
  "P5000" = "cuartos", # Cantidad de cuartos en el hogar
  "P5010" = "dormitorios", # Cantidad de cuartos usados como dormitorios
  "P5090" = "viv_prop", # La vivienda es propia, arrendada, usufructuada, etc.
  "P5100" = "cuota_amort", # Valor de la cuota de amortización
  "P5130" = "estim_arriendo", # Estimación del valor de habitar la vivienda en caso de ser arrendada
  "P5140" = "arriendo" # Valor del arriendo
  )
# Se renombran las variables para facilidad de manejo, de acuerdo con el diccionario "rename_dict"
bd_train <- bd_train %>%
  rename_with(~ rename_dict[.x], .cols = names(rename_dict))

# Se ajustan los valores de algunas variables para evitar categorías irrelevantes
bd_train <- bd_train %>%
  mutate(female = ifelse(female==2, 1, 0)) %>%
  mutate(reg_salud = ifelse(reg_salud==9, 4, reg_salud)) %>%
  mutate(educ = ifelse(educ==9, 1, educ))

lista_unos_ceros <- c(
  "coti_salud",
  "ocupado",
  "inactivo",
  "horas_extra",
  "primas",
  "bonificaciones",
  "alimentacion",
  "aux_transporte",
  "sub_familiar",
  "sub_educ",
  "ie_alimentacion",
  "ie_vivienda",
  "trans_empresa",
  "ie_otros",
  "prima_servicios",
  "prima_navidad",
  "prima_vacaciones", 
  "viaticos",
  "bono_anual",
  "segundo_trabajo",
  "interes_mas_hr", 
  "intent_mas_hr", 
  "dispon_mas_hr", 
  "busca_trabajo", 
  "dispon_nuevo_trab",
  "primer_trabajo",
  "ingreso_anterior",
  "ing_arriendo",
  "ing_pension", 
  "ing_alimentos",
  "remesa_nal",
  "remesa_ext",
  "ayudas",
  "ing_int",
  "ing_otros"
)

# Función para conservar los valores 1 y volver los demás 0, así como llenar NA con 0
unos_ceros <- function(bd, lista) {
  
  for (var in lista) {
    bd <- bd %>%
      mutate(!!var := ifelse(.data[[var]] == 1, 1, 0)) %>%
      mutate(!!var := replace_na(.data[[var]], 0))
  }
  
  return(bd)
}

# Aquí se aplica la función "unos_ceros"
bd_train <- unos_ceros(bd_train, lista_unos_ceros)

cols_cero <- c(
  "tenure",
  "grado_escolar",
  "hr_lab",
  "hr_lab2",
  "cuota_amort",
  "estim_arriendo",
  "arriendo",
  "Ingtot"
  )

# Ajuste de variables con más de dos categorías para llenar NA con valores correspondientes
bd_train <- bd_train %>%
  mutate(across(all_of(cols_cero), ~ replace_na(., 0))) %>%
  mutate(educ = replace_na(educ, 1)) %>%
  mutate(empleados_empresa = replace_na(empleados_empresa, 1)) %>%
  mutate(ocu_sem_pas = replace_na(ocu_sem_pas, 2)) %>%
  mutate(cotiz_pension = replace_na(cotiz_pension, 2)) %>%
  mutate(reg_salud = replace_na(reg_salud, 4)) %>%
  mutate(viv_prop = replace_na(viv_prop, 6)) %>%
  mutate(cargo = replace_na(cargo, 9))  %>%
  mutate(cargo2 = replace_na(cargo2, 9)) %>%
  mutate(cargo_anterior = replace_na(cargo_anterior, 9)) %>%
  mutate(oficio = replace_na(oficio, 99))

cols_to_factor <- c(
  "Clase", 
  "Dominio", 
  "Depto", 
  "female", 
  "coti_salud", 
  "reg_salud", 
  "educ", 
  "oficio", 
  "cargo", 
  "ocupado",
  "inactivo", 
  "Pobre",
  "ocu_sem_pas",
  "horas_extra",
  "primas",
  "bonificaciones",
  "alimentacion",
  "aux_transporte",
  "sub_familiar",
  "sub_educ", 
  "ie_alimentacion",
  "ie_vivienda",
  "ie_otros",
  "alimentacion",
  "trans_empresa",
  "prima_servicios",
  "prima_navidad",
  "prima_vacaciones",
  "viaticos", 
  "bono_anual",
  "empleados_empresa",
  "cotiz_pension",
  "segundo_trabajo",
  "cargo2",
  "interes_mas_hr",
  "intent_mas_hr",
  "dispon_mas_hr",
  "busca_trabajo",
  "dispon_nuevo_trab",
  "primer_trabajo",
  "cargo_anterior",
  "ingreso_anterior",
  "ing_arriendo",
  "ing_pension",
  "ing_alimentos",
  "remesa_nal",
  "remesa_ext",
  "ayudas",
  "ing_int",
  "ing_otros",
  "viv_prop"
  )

# Conversión de variables categóricas a factor
bd_train <- bd_train %>%
  mutate(across(all_of(cols_to_factor), as.factor))
```

Limpieza de la partición para validación

```{r}
bd_validation <- bd_validation %>%
  rename_with(~ rename_dict[.x], .cols = names(rename_dict))

bd_validation <- bd_validation %>%
  mutate(female = ifelse(female==2, 1, 0)) %>%
  mutate(reg_salud = ifelse(reg_salud==9, 4, reg_salud)) %>%
  mutate(educ = ifelse(educ==9, 1, educ))

bd_validation <- unos_ceros(bd_validation, lista_unos_ceros)

bd_validation <- bd_validation %>%
  mutate(across(all_of(cols_cero), ~ replace_na(., 0))) %>%
  mutate(educ = replace_na(educ, 1)) %>%
  mutate(empleados_empresa = replace_na(empleados_empresa, 1)) %>%
  mutate(ocu_sem_pas = replace_na(ocu_sem_pas, 2)) %>%
  mutate(cotiz_pension = replace_na(cotiz_pension, 2)) %>%
  mutate(reg_salud = replace_na(reg_salud, 4)) %>%
  mutate(viv_prop = replace_na(viv_prop, 6)) %>%
  mutate(cargo = replace_na(cargo, 9))  %>%
  mutate(cargo2 = replace_na(cargo2, 9)) %>%
  mutate(cargo_anterior = replace_na(cargo_anterior, 9)) %>%
  mutate(oficio = replace_na(oficio, 99))

bd_validation <- bd_validation %>%
  mutate(across(all_of(cols_to_factor), as.factor))
```

## Limpieza de la BD test

```{r}
# A la bd_test se le aplica el mismo proceso de limpieza que a bd_train
bd_test <- bd_test %>%
  rename_with(~ rename_dict[.x], .cols = names(rename_dict))

bd_test <- bd_test %>%
  mutate(female = ifelse(female==2, 1, 0)) %>%
  mutate(reg_salud = ifelse(reg_salud==9, 4, reg_salud)) %>%
  mutate(educ = ifelse(educ==9, 1, educ))

bd_test <- unos_ceros(bd_test, lista_unos_ceros)

cols_cero_test <- setdiff(cols_cero, "Ingtot")

bd_test <- bd_test %>%
  mutate(across(all_of(cols_cero_test), ~ replace_na(., 0))) %>%
  mutate(educ = replace_na(educ, 1)) %>%
  mutate(empleados_empresa = replace_na(empleados_empresa, 1)) %>%
  mutate(ocu_sem_pas = replace_na(ocu_sem_pas, 2)) %>%
  mutate(cotiz_pension = replace_na(cotiz_pension, 2)) %>%
  mutate(reg_salud = replace_na(reg_salud, 4)) %>%
  mutate(viv_prop = replace_na(viv_prop, 6)) %>%
  mutate(cargo = replace_na(cargo, 9))  %>%
  mutate(cargo2 = replace_na(cargo2, 9)) %>%
  mutate(cargo_anterior = replace_na(cargo_anterior, 9)) %>%
  mutate(oficio = replace_na(oficio, 99))

cols_to_factor_test <- setdiff(cols_to_factor, "Pobre")

bd_test <- bd_test %>%
  mutate(across(all_of(cols_to_factor_test), as.factor))
```

Especificación modelo 1a

```{r}
model_form1a <- Ingtot ~ 
  Clase + Dominio + Depto + nper + female + age + coti_salud + reg_salud + 
  educ + grado_escolar + ocupado +  inactivo + ocu_sem_pas +  oficio + tenure +
  cargo + horas_extra + primas +  bonificaciones + alimentacion + aux_transporte +
  sub_familiar + sub_educ + ie_alimentacion + ie_vivienda + trans_empresa +    
  ie_otros + prima_servicios + prima_navidad + prima_vacaciones + viaticos +
  bono_anual + hr_lab + empleados_empresa + cotiz_pension + segundo_trabajo +
  hr_lab2 + cargo2 + interes_mas_hr + intent_mas_hr + dispon_mas_hr +
  primer_trabajo + dispon_nuevo_trab + cargo_anterior +  
  ingreso_anterior + ing_arriendo + ing_pension + ing_alimentos + remesa_nal +
  remesa_ext + ayudas + ing_int + ing_otros + cuartos + dormitorios +
  cuota_amort + estim_arriendo + arriendo

# Se excluyen las observaciones de menores con NA (en principio no había por la limpieza previa, pero salió error)
bd_modelo1 <- na.omit(bd_train)

# Implementción de elastic net para determinar los predictores más relevantes y sus coeficientes
set.seed(2903)

fitControl <- trainControl( 
  method = "cv",
  number = 10)

# Los valores de alpha y lambda son muchos, el computador tomo casi 30 mins en ejecutar el código
#tune_grid <- expand.grid(
#  alpha=seq(0, 1, 0.01),
#  lambda=seq(0, 5, 0.05)
#)
#
#model1a <- train(
#  model_form1a,
#  data=bd_train,
#  method='glmnet',
#  trControl=fitControl,
#  tuneGrid=tune_grid
#)
```

Especificación modelo 1b

```{r}
model_form1e <- Ingtot ~ 
  Clase + Dominio + Depto + nper + female + age + coti_salud + reg_salud + 
  educ + grado_escolar + ocupado + ocu_sem_pas +  oficio + tenure +
  cargo + horas_extra + primas +  bonificaciones + alimentacion + aux_transporte +
  sub_familiar + sub_educ + ie_alimentacion + ie_vivienda + trans_empresa +    
  ie_otros + prima_servicios + prima_navidad + prima_vacaciones + viaticos +
  bono_anual + hr_lab + empleados_empresa + cotiz_pension + segundo_trabajo +
  hr_lab2 + cargo2 + interes_mas_hr + intent_mas_hr + dispon_mas_hr +
  primer_trabajo + dispon_nuevo_trab + cargo_anterior +  
  ingreso_anterior + ing_arriendo + ing_pension + ing_alimentos + remesa_nal +
  remesa_ext + ayudas + ing_int + ing_otros + cuartos + dormitorios +
  cuota_amort + estim_arriendo
```

Modelo de regresión

```{r}
bd_train <- na.omit(bd_train)

# Implementción de elastic net para determinar los predictores más relevantes y sus coeficientes
set.seed(2903)

fitControl <- trainControl( 
  method = "cv",
  number = 10)

# A través de iteraciones previas identificamos como valores optimos de alpha 0.03 y 
# de lambda 4600, sin embargo usando glmnet obtivimos lambda óptimo de 30140.85
tune_grid <- expand.grid(
  alpha=0.03,
  lambda=seq(4616, 4618, 0.2)
)

model1b <- train(
  model_form1e,
  data=bd_train,
  method='glmnet',
  trControl=fitControl,
  tuneGrid=tune_grid
)
```

Predicción usando el modelo1b con los valores de alpha y lambda óptimos

```{r}
prediccion_2903 <- predict(model1e, newdata=bd_test)

df_pred <- bd_test %>%
  select(id, nper) %>%
  as.data.frame() %>%
  mutate(ing_indiv = !!prediccion_2903) %>%
  group_by(id) %>%
  summarise(
    ingreso_hogar = sum(ing_indiv, na.rm = TRUE),
    nper = first(nper),
    Ingtotug = ingreso_hogar / nper
  ) %>%
  mutate(Pobre = ifelse(Ingtotug <= 289878.2, 1, 0)) %>%
  select(id, Pobre)
```

```{r}
write.csv(df_pred, "pred2903.csv", row.names = FALSE)
```

Intento de ajustar el modelo con glmnet

```{r}
#library(glmnet)
#
#y <- bd_modelo_d$Ingtot
#
#X <- model.matrix(~Ingtot + Clase + Dominio + Depto + nper + female + age + coti_salud + reg_salud + 
#  educ + grado_escolar + ocupado + ocu_sem_pas +  oficio + tenure +
#  cargo + horas_extra + primas +  bonificaciones + alimentacion + aux_transporte +
#  sub_familiar + sub_educ + ie_alimentacion + ie_vivienda + trans_empresa +    
#  ie_otros + prima_servicios + prima_navidad + prima_vacaciones + viaticos +
#  bono_anual + hr_lab + empleados_empresa + cotiz_pension + segundo_trabajo +
#  hr_lab2 + cargo2 + interes_mas_hr + intent_mas_hr + dispon_mas_hr +
#  primer_trabajo + dispon_nuevo_trab + cargo_anterior +  
#  ingreso_anterior + ing_arriendo + ing_pension + ing_alimentos + remesa_nal +
#  remesa_ext + ayudas + ing_int + ing_otros + cuartos + dormitorios +
#  cuota_amort + estim_arriendo, bd_modelo_d) 
#
#X <- X[, -1]
#
#modelo_lambda <- cv.glmnet(X, y, alpha = 0.03)  # Cambia alpha según tu necesidad
#
## Obtener el mejor lambda
#best_lambda <- modelo_lambda$lambda.min
#print(best_lambda)
```

## Pruebas MATEO

```{r}
model_form2a <- Ingtot ~ 
  Clase + Dominio + Depto + nper + female + age + coti_salud + reg_salud + 
  educ + poly(age, 2, raw=TRUE):educ + grado_escolar + ocupado + ocu_sem_pas + oficio + 
  poly(age, 2, raw=TRUE):oficio + tenure + cargo + aux_transporte + primer_trabajo + 
  ing_arriendo + remesa_nal + remesa_ext + ayudas + ing_int + ing_otros +
  educ:bono_anual + hr_lab + empleados_empresa + cotiz_pension + cuartos + dormitorios +
  cuota_amort + estim_arriendo
  # horas_extra + primas +  bonificaciones + alimentacion + ie_otros +
  # sub_familiar + sub_educ + ie_alimentacion + ie_vivienda + trans_empresa +    
  # prima_servicios + prima_navidad + prima_vacaciones + viaticos +
  # segundo_trabajo + hr_lab2 + cargo2 + interes_mas_hr + intent_mas_hr + dispon_mas_hr +
  # dispon_nuevo_trab + cargo_anterior + ingreso_anterior + ing_pension + ing_alimentos +
```

Modelo de regresión

```{r}
bd_train <- na.omit(bd_train)

# Implementción de elastic net para determinar los predictores más relevantes y sus coeficientes
set.seed(3003)

fitControl <- trainControl( 
  method = "cv",
  number = 5)

tune_grid <- expand.grid(
  alpha=c(0.046, 0.047, 0.048),
  lambda=c(1550, 1600, 1650)
  )

model2a <- train(
  model_form2a,
  data=bd_train,
  method='glmnet',
  trControl=fitControl,
  tuneGrid=tune_grid
)

```

```{r}
prediccion_104 <- predict(model2a, newdata=bd_test)

df_pred <- bd_test %>%
  select(id, nper) %>%
  as.data.frame() %>%
  mutate(ing_indiv = !!prediccion_104) %>%
  group_by(id) %>%
  summarise(
    ingreso_hogar = sum(ing_indiv, na.rm = TRUE),
    nper = first(nper),
    Ingtotug = ingreso_hogar / nper
  ) %>%
  mutate(lp = hogares_te$Lp) %>%
  mutate(Pobre = ifelse(Ingtotug < lp, 1, 0)) %>%
  select(id, Pobre)

write.csv(df_pred, "enet_lambda_1550_alpha_0.46.csv", row.names = FALSE)
```

```{r}
prediccion_3003 <- predict(model2a, newdata=bd_test)

df_pred <- bd_validation %>%
  select(id, Pobre) %>%
  mutate(Pobre_hat = ifelse(prediccion_3003 <= 289878.2, 1, 0))
```

```{r}
#install.packages("MLmetrics")
#
#library(MLmetrics)

F1_Score(y_pred = df_pred$Pobre_hat, y_true = df_pred$Pobre, positive = "1")
```

Intento de Random Forest

```{r}
model_tree1 <- Pobre ~ 
  Clase + Dominio + Depto + nper + female + age + coti_salud + reg_salud + 
  educ + grado_escolar + ocupado + ocu_sem_pas +  oficio + tenure +
  cargo + horas_extra + primas +  bonificaciones + alimentacion + aux_transporte +
  sub_familiar + sub_educ + ie_alimentacion + ie_vivienda + trans_empresa +    
  ie_otros + prima_servicios + prima_navidad + prima_vacaciones + viaticos +
  bono_anual + hr_lab + empleados_empresa + cotiz_pension + segundo_trabajo +
  hr_lab2 + cargo2 + interes_mas_hr + intent_mas_hr + dispon_mas_hr +
  primer_trabajo + dispon_nuevo_trab + cargo_anterior +  
  ingreso_anterior + ing_arriendo + ing_pension + ing_alimentos + remesa_nal +
  remesa_ext + ayudas + ing_int + ing_otros + cuartos + dormitorios +
  cuota_amort + estim_arriendo
```

```{r}
set.seed(3003)

fitControl <- trainControl( 
  method = "cv",
  number = 5)

tree_grid <- expand.grid(
    mtry = c(3, 4, 5),
    splitrule = "gini",
    min.node.size = c(10, 25, 50)
)

tree_model1 <- train(
    model_tree1,  # Fórmula del modelo
    data = bd_train,  # Dataset de entrenamiento
    method = "ranger",  # Usamos el motor ranger para Random Forests
    trControl = fitControl,  # Especificamos los controles de validación cruzada definidos antes
    tuneGrid = tree_grid,
    num.trees = 100,
    importance = "impurity"  # Calculamos la importancia de variables por permutación
)
```

```{r}
# Imprimir el modelo entrenado
print(tree_model1)

# Visualizar el desempeño en función del número de árboles
plot(tree_model1)

# Hacer predicciones en el conjunto de prueba
predictions <- predict(tree_model1, bd_test)

# Evaluar el desempeño con matriz de confusión
conf_matrix <- confusionMatrix(predictions, bd_validation$Pobre)
print(conf_matrix)

df_pred <- bd_validation %>%
  select(id) %>%
  mutate(Pobre = predictions)

F1_Score(y_pred = df_pred$Pobre_hat, y_true = df_pred$Pobre, positive = "1")
```

```{r}
df_pred <- bd_test %>%
  select(id) %>%
  mutate(Pobre = as.numeric(!!predictions)) %>%
  group_by(id) %>%
  summarise(
    Pobre = sum(Pobre, na.rm = TRUE)
  ) %>%
  mutate(Pobre = ifelse(Pobre >= 3, 1, 0)) %>%
  select(id, Pobre)
```

```{r}
write.csv(df_pred, "RF_mtry_5_split_gini_node_25_trees_100", row.names = FALSE)
```

# Pruebas finales de los modelos con las bases de datos correctas

```{r}
#Cargamos bases de datos 
raw_data_path <- '../data'

# Datos 
bd_train <- read.csv(file.path(raw_data_path, 'bd_train_limpia.csv'))
bd_test <- read.csv(file.path(raw_data_path, 'bd_test_limpia.csv'))


#Selección de variables relevantes
variables_modelo <- c("Pobre", "Clase", "Dominio", "num_room", "num_bed", "propiedad",
                      "pago_amort", "renta_h", "renta_r", "Nper", "Depto", "suma_antiguedad", 
                      "promedio_antiguedad", "tiene_empleado_publico",
                      "tiene_patron", "tiene_cuenta_propia", "tiene_emp_domestico",       
                      "tiene_jornalero", "tiene_sin_remuneracion", 
                      "n_posiciones_lab_distintas", "aux_trans", "ind_prima",
                      "prima_serv", "prima_nav", "prima_vac", "ind_viaticos", 
                      "ocupado", "ind_oficio", "ind_arriendo", "pet_trabajo",                
                      "max_educ", "hr_extr", "otro_tr", "rem_ext", "reg_cotiz",
                      "cotiz_pen", "ing_otros", "edad_prom", "perc_fem")

#Preparación de la base de entrenamiento
setDT(bd_train)
train <- bd_train[, .SD, .SDcols = c("id", variables_modelo)]

#Preparación del conjunto de prueba 
variables_modelo_te <- setdiff(variables_modelo, "Pobre")
setDT(bd_test)
test <- bd_test[, .SD, .SDcols = c("id", variables_modelo_te)]


# ---------------------------------------------------------------------------------
set.seed(123)

train <- na.omit(train)

# Boosting con XGBoost
# Preparar matrices para XGBoost
train_numeric <- train[, lapply(.SD, function(x) as.numeric(as.character(x))), .SDcols = variables_modelo[-1]]
train_matrix <- xgb.DMatrix(
  data = as.matrix(train_numeric),
  label = as.numeric(train$Pobre) - 1
)

# Entrenar modelo XGBoost
boost_model <- xgboost(
  data = train_matrix,
  max.depth = 6,
  nrounds = 100,
  objective = "binary:logistic",
  verbose = 0
)

#Evaluación del modelo en la base de test
test <- na.omit(test)

test_numeric <- test[, lapply(.SD, function(x) as.numeric(as.character(x))), .SDcols = variables_modelo_te]
test_matrix <- xgb.DMatrix(
  data = as.matrix(test_numeric[, variables_modelo_te, with = FALSE])
)

boost_pred <- predict(boost_model, newdata = test_matrix)

df_pred <- bd_test %>%
  select(id) %>%
  mutate(prob = boost_pred) %>%
  mutate(Pobre = ifelse(prob > 0.5, 1, 0)) %>%
  select(id, Pobre)

#-------------------------------------------------------------------------------

#Entrenamiento de modelo de Random Forest
model_tree <- Pobre ~ Clase + Dominio + num_room + num_bed + propiedad + pago_amort + renta_h + 
  renta_r + Nper + Depto + suma_antiguedad + promedio_antiguedad + 
  tiene_empleado_publico + tiene_patron + tiene_cuenta_propia + 
  tiene_emp_domestico + tiene_jornalero + tiene_sin_remuneracion + 
  n_posiciones_lab_distintas + aux_trans + ind_prima + prima_serv + prima_nav + 
  prima_vac + ind_viaticos + ocupado + ind_oficio + ind_arriendo + pet_trabajo + 
  max_educ + hr_extr + otro_tr + rem_ext + reg_cotiz + cotiz_pen + ing_otros + 
  edad_prom + perc_fem


#Entrenamiento y definición de hiperparámetros para el modelo de Random Forest
set.seed(404)

fitControl <- trainControl( 
  method = "cv",
  number = 5)

tree_grid <- expand.grid(
    mtry = c(7, 8, 10),
    splitrule = "gini",
    min.node.size = c(5, 7, 9)
)

tree_model <- train(
    model_tree,  # Fórmula del modelo
    data = bd_train,  # Dataset de entrenamiento
    method = "ranger",  # Usamos el motor ranger para Random Forests
    trControl = fitControl,  # Especificamos los controles de validación cruzada definidos antes
    tuneGrid = tree_grid,
    num.trees = 250,
    importance = "impurity"  # Calculamos la importancia de variables por permutación
)

#Predicciones del modelo de Random Forest 
predictions <- predict(tree_model, bd_test)

df_pred_arbol <- bd_test %>%
  select(id) %>%
  mutate(Pobre = as.numeric(!!predictions)) %>%
  mutate(Pobre = ifelse(Pobre==2, 1, 0))


#----------------------------------------------------------------------------------

#Modelo de MPL 
set.seed(123)

split_interno <- createDataPartition(bd_train$Pobre, p = 0.8, list = FALSE)
sub_train <- bd_train[split_interno, ]
sub_test  <- bd_train[-split_interno, ]

#Creación del modelo 
mpl_model <- Pobre ~ Clase + Dominio + num_room + num_bed + propiedad + pago_amort + renta_h + 
  renta_r + Nper + Depto + suma_antiguedad + promedio_antiguedad + 
  tiene_empleado_publico + tiene_patron + tiene_cuenta_propia + 
  tiene_emp_domestico + tiene_jornalero + tiene_sin_remuneracion + 
  n_posiciones_lab_distintas + aux_trans + ind_prima + prima_serv + prima_nav + 
  prima_vac + ind_viaticos + ocupado + ind_oficio + ind_arriendo + pet_trabajo + 
  max_educ + hr_extr + otro_tr + rem_ext + reg_cotiz + cotiz_pen + ing_otros + 
  edad_prom + perc_fem

summary(mpl_model)

#Prediccion de probabilidades con sub set de testeo
predict_mpl <- predict(mpl_model, newdata = sub_test)

#Clasificación con umbral de bayes
sub_test$clase_pred <- factor(ifelse(predict_mpl > 0.5, 1, 0), levels = c(0,1))
sub_test$Pobre <- factor(sub_test$Pobre, levels = c(0, 1))

#Revision interna 
confusionMatrix(sub_test$clase_pred, sub_test$Pobre)

roc_obj <- roc(sub_test$Pobre, predict_mpl)
auc(roc_obj)


#...Predicciones finales para base de test
prob_final_mpl <- predict(mpl_model, newdata = bd_test)

# Crear una variable binaria según umbral
bd_test$pred_class <- ifelse(prob_final_mpl > 0.5, 1, 0)

#Selección de resultados 
resultados_mpl <- bd_test[, c("id", "pred_class")]

# Exportar a CSV (sin índices de fila)
write.csv(resultados_mpl, "MPL_bayes_05.csv", row.names = FALSE)
```

Prueba del mpl

```{r}
set.seed(123)

#Omite los valores faltantes
bd_train <- na.omit(bd_train)


#Definicion del modelo
mpl_model <- Pobre ~ Clase + Dominio + num_room + num_bed + propiedad + pago_amort + renta_h + 
  renta_r + Nper + Depto + suma_antiguedad + promedio_antiguedad + 
  tiene_empleado_publico + tiene_patron + tiene_cuenta_propia + 
  tiene_emp_domestico + tiene_jornalero + tiene_sin_remuneracion + 
  n_posiciones_lab_distintas + aux_trans + ind_prima + prima_serv + prima_nav + 
  prima_vac + ind_viaticos + ocupado + ind_oficio + ind_arriendo + pet_trabajo + 
  max_educ + hr_extr + otro_tr + rem_ext + reg_cotiz + cotiz_pen + ing_otros + 
  edad_prom + perc_fem


#Establecer funcion para e 
sixStats <- function(data, lev = NULL, model = NULL) {
  # Calcula las métricas estándar
  twoClass <- twoClassSummary(data, lev, model)
  default <- defaultSummary(data, lev, model)
  
  # Calcula el F1 Score
  f1 <- F1_Score(data$obs, data$pred, positive = lev[2])
  
  # Combina todas las métricas
  c(twoClass, default, F1 = f1)
}


fitControl <- trainControl( 
  method = "cv",
  classProbs = TRUE,
  savePredictions = TRUE,
  summaryFunction = sixStats,
  number = 5)

tune_grid <- expand.grid(
  alpha=c(0.02),
  lambda=c(0)
  )

bd_estan$Pobre <- as.factor(bd_estan$Pobre)
bd_train$Pobre <- as.factor(bd_train$Pobre)
levels(bd_estan$Pobre) <- make.names(levels(bd_train$Pobre))
levels(bd_train$Pobre) <- c("No", "Si")

modelo_mpl <- train(
  mpl_model,
  data=bd_train,
  method='glmnet',
  trControl=fitControl,
  tuneGrid=tune_grid, 
  metric = "F1",       # Optimizar por F1
  maximize = TRUE,     # Queremos maximizar F1
  preProcess = c("center", "scale")
)


#Resultado del modelo 
print(modelo_mpl)
```

```{r}
#Path
predictions_path <- '../results/predictions'

# Obtener predicciones (clases: "No_Pobre" o "Pobre")
predict_mpl <- predict(modelo_mpl, newdata = bd_test)
bd_test$prob_pobre <- predict_mpl

mpl <- bd_test %>%
  select(id, prob_pobre) %>%
  mutate(prob_pobre = as.numeric(prob_pobre)) %>%
  mutate(Pobre = ifelse(prob_pobre >= 0.5, 1,0)) %>% 
  select(id, Pobre)

# Create descriptive filename
filename <- sprintf("%s/MPL_EN_lambda_00_alpha_00%s.csv", 
                   predictions_path,
                   format(Sys.time(), "%Y%m%d_%H%M"))

# 6. Save with proper format
write.csv(mpl, 
          file = filename,
          row.names = FALSE,
          quote=FALSE)



```

```{r}
#------------------------ con algunas transformaciones-----------------------------
set.seed(123)

bd_train <- na.omit(bd_train)

mpl_model <- Pobre ~ Clase + Dominio + num_room + num_bed + propiedad + pago_amort + renta_h + 
  renta_r + Nper + Depto + suma_antiguedad + promedio_antiguedad + 
  tiene_empleado_publico + tiene_patron + tiene_cuenta_propia + 
  tiene_emp_domestico + tiene_jornalero + tiene_sin_remuneracion + 
  n_posiciones_lab_distintas + aux_trans + ind_prima + prima_serv + prima_nav + 
  prima_vac + ind_viaticos + ocupado + ind_oficio + ind_arriendo + pet_trabajo + 
  max_educ + hr_extr + otro_tr + rem_ext + reg_cotiz + cotiz_pen + ing_otros + 
  edad_prom + perc_fem

fitControl <- trainControl( 
  method = "cv",
  number = 5,
  classProbs = TRUE,
  summaryFunction = twoClassSummary)

tune_grid <- expand.grid(
  alpha=c(0.8, 1, 0.02),
  lambda=c(0, 0.01, 0.005)
  )

bd_train$Pobre <- as.factor(bd_train$Pobre)

modelo_mpl <- train(
  mpl_model,
  data=bd_train,
  method='glmnet',
  trControl=fitControl,
  tuneGrid=tune_grid, 
  metric='ROC'
)

```

```{r}


#Selección de variables relevantes
variables_modelo <- c("Pobre", "Clase", "Dominio", "num_room", "num_bed", "propiedad",
                      "pago_amort", "renta_h", "renta_r", "Nper", "Depto", "suma_antiguedad", 
                      "promedio_antiguedad", "tiene_empleado_publico",
                      "tiene_patron", "tiene_cuenta_propia", "tiene_emp_domestico",       
                      "tiene_jornalero", "tiene_sin_remuneracion", 
                      "n_posiciones_lab_distintas", "aux_trans", "ind_prima",
                      "prima_serv", "prima_nav", "prima_vac", "ind_viaticos", 
                      "ocupado", "ind_oficio", "ind_arriendo", "pet_trabajo",                
                      "max_educ", "hr_extr", "otro_tr", "rem_ext", "reg_cotiz",
                      "cotiz_pen", "ing_otros", "edad_prom", "perc_fem")

#Preparación de la base de entrenamiento
setDT(bd_train)
train <- bd_train[, .SD, .SDcols = c("id", variables_modelo)]

#Preparación del conjunto de prueba 
variables_modelo_te <- setdiff(variables_modelo, "Pobre")
setDT(bd_test)
test <- bd_test[, .SD, .SDcols = c("id", variables_modelo_te)]
```
